{% extends "base.html" %}
{% load static %}

{% block content %}
    <div style="text-align: center;">
        <h3>üå±ËÖ∏Ê¥ª„ÉÅ„Çß„ÉÉ„ÇØ - Â±•Ê≠¥üå±</h3>

        <div class="card shadow-sm mx-auto" style="max-width: 600px; margin-bottom: 20px;">
            <div class="card-header bg-white">
                <h4 class="mb-0">Â±•Ê≠¥</h4>
            </div>
            <div class="card-body">
                <!-- „Éï„Ç£„É´„Çø„Éº„Éï„Ç©„Éº„É† -->
                <form method="get" class="mb-3">
                    <div class="row g-2">
                        <div class="col-md-4">
                            <label for="mood_filter" class="form-label">Ë™øÂ≠ê„Éï„Ç£„É´„Çø„Éº</label>
                            <select class="form-select" id="mood_filter" name="mood">
                                <option value="">„Åô„Åπ„Å¶</option>
                                {% for i in '12345'|make_list %}
                                    <option value="{{ i }}"
                                            {% if mood_filter == i %}selected{% endif %}>{{ i }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label for="start_date" class="form-label">ÈñãÂßãÊó•</label>
                            <input type="date" class="form-control" id="start_date" name="start_date"
                                   value="{{ start_date|date:'Y-m-d' }}">
                        </div>
                        <div class="col-md-4">
                            <label for="end_date" class="form-label">ÁµÇ‰∫ÜÊó•</label>
                            <input type="date" class="form-control" id="end_date" name="end_date"
                                   value="{{ end_date|date:'Y-m-d' }}">
                        </div>
                    </div>
                    <div class="mt-2 text-center">
                        <button type="submit" class="btn btn-primary">„Éï„Ç£„É´„Çø„Éº</button>
                    </div>
                </form>

                <!-- CSV„ÉÄ„Ç¶„É≥„É≠„Éº„Éâ„Éú„Çø„É≥ -->
                <div class="d-flex justify-content-end mb-3">
                    <a href="{% url 'gut_health:export_csv_form' %}" class="btn btn-outline-success me-2">
                        <i class="fas fa-cog"></i> CSV„Ç®„ÇØ„Çπ„Éù„Éº„ÉàË®≠ÂÆö
                    </a>
                    <form method="get" action="{% url 'gut_health:export_csv' %}">
                        <!-- ÁèæÂú®„ÅÆ„Éï„Ç£„É´„Çø„ÉºÊù°‰ª∂„ÇíÁ∂≠ÊåÅ -->
                        <input type="hidden" name="mood" value="{{ mood_filter }}">
                        <input type="hidden" name="start_date" value="{{ start_date|date:'Y-m-d' }}">
                        <input type="hidden" name="end_date" value="{{ end_date|date:'Y-m-d' }}">

                        <button type="submit" class="btn btn-success">
                            <i class="fas fa-file-download"></i> CSV„Åß„ÉÄ„Ç¶„É≥„É≠„Éº„Éâ
                        </button>
                    </form>
                </div>

                <!-- „Éá„Éº„Çø„ÉÜ„Éº„Éñ„É´ -->
                <div class="table-responsive">
                    <table class="table table-bordered table-hover">
                        <thead>
                        <tr>
                            <th>Êó•‰ªò</th>
                            <th>ÈÅîÊàêÊï∞</th>
                            <th>Ë™øÂ≠ê</th>
                            <th>ÊëÇÂèñ„Åó„ÅüÈ£üÊùê</th>
                            <th>„É°„É¢</th>
                        </tr>
                        </thead>
                        <tbody>
                        {% for check in checks %}
                            <tr>
                                <td>
                                    <a href="{% url 'gut_health:index' %}?date={{ check.date|date:'Y-m-d' }}">
                                        {{ check.date|date:"Y/m/d" }}
                                    </a>
                                </td>
                                <td class="text-center">
                                    <span class="badge {% if check.achievement_count >= 7 %}bg-success{% elif check.achievement_count >= 4 %}bg-warning{% else %}bg-danger{% endif %}">
                                        {{ check.achievement_count }}/9
                                    </span>
                                </td>
                                <td class="text-center">
                                    {% if check.mood %}
                                        <span class="badge bg-{% if check.mood >= 4 %}success{% elif check.mood >= 3 %}warning{% else %}danger{% endif %}">
                                            {{ check.mood }}
                                        </span>
                                    {% else %}
                                        -
                                    {% endif %}
                                </td>
                                <td>
                                    {% for category in check.achievements %}
                                        <span class="badge bg-info">{{ category }}</span>
                                    {% empty %}
                                        <span class="text-muted">„Éá„Éº„Çø„Å™„Åó</span>
                                    {% endfor %}
                                </td>
                                <td>
                                    {% if check.memo %}
                                        {{ check.memo|truncatechars:30 }}
                                    {% else %}
                                        -
                                    {% endif %}
                                </td>
                            </tr>
                        {% empty %}
                            <tr>
                                <td colspan="5" class="text-center">Ë©≤ÂΩì„Åô„Çã„Éá„Éº„Çø„ÅØ„ÅÇ„Çä„Åæ„Åõ„Çì</td>
                            </tr>
                        {% endfor %}
                        </tbody>
                    </table>
                </div>

                <!-- „Éö„Éº„Ç∏„Éç„Éº„Ç∑„Éß„É≥ -->
                {% if checks.has_other_pages %}
                    <nav aria-label="Â±•Ê≠¥„Éö„Éº„Ç∏„Éä„Éì„Ç≤„Éº„Ç∑„Éß„É≥">
                        <ul class="pagination justify-content-center">
                            {% if checks.has_previous %}
                                <li class="page-item">
                                    <a class="page-link"
                                       href="?page=1&mood={{ mood_filter }}&start_date={{ start_date|date:'Y-m-d' }}&end_date={{ end_date|date:'Y-m-d' }}">ÊúÄÂàù</a>
                                </li>
                                <li class="page-item">
                                    <a class="page-link"
                                       href="?page={{ checks.previous_page_number }}&mood={{ mood_filter }}&start_date={{ start_date|date:'Y-m-d' }}&end_date={{ end_date|date:'Y-m-d' }}">Ââç„Å∏</a>
                                </li>
                            {% endif %}

                            {% for num in checks.paginator.page_range %}
                                {% if checks.number == num %}
                                    <li class="page-item active"><span class="page-link">{{ num }}</span></li>
                                {% elif num > checks.number|add:'-3' and num < checks.number|add:'3' %}
                                    <li class="page-item">
                                        <a class="page-link"
                                           href="?page={{ num }}&mood={{ mood_filter }}&start_date={{ start_date|date:'Y-m-d' }}&end_date={{ end_date|date:'Y-m-d' }}">{{ num }}</a>
                                    </li>
                                {% endif %}
                            {% endfor %}

                            {% if checks.has_next %}
                                <li class="page-item">
                                    <a class="page-link"
                                       href="?page={{ checks.next_page_number }}&mood={{ mood_filter }}&start_date={{ start_date|date:'Y-m-d' }}&end_date={{ end_date|date:'Y-m-d' }}">Ê¨°„Å∏</a>
                                </li>
                                <li class="page-item">
                                    <a class="page-link"
                                       href="?page={{ checks.paginator.num_pages }}&mood={{ mood_filter }}&start_date={{ start_date|date:'Y-m-d' }}&end_date={{ end_date|date:'Y-m-d' }}">ÊúÄÂæå</a>
                                </li>
                            {% endif %}
                        </ul>
                    </nav>
                {% endif %}
            </div>
        </div>

        <button type="button" class="btn btn-outline-warning"
                onclick="location.href='{% url 'gut_health:index' %}'">
            ‰ªäÊó•„ÅÆË®òÈå≤„Å´Êàª„Çã
        </button>
    </div>
{% endblock %}