{% extends "base.html" %}
{% load static %}

{% block content %}


<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="csrf-token" content="{{ csrf_token }}">
    <style>
        .camera-container {
            position: relative;
            width: 200px; /* å¹…ã‚’320pxã«è¨­å®š */
            height: 200px; /* é«˜ã•ã‚‚320pxã«è¨­å®šã—ã¦1:1ã®ã‚¢ã‚¹ãƒšã‚¯ãƒˆæ¯”ã«ã™ã‚‹ */
            margin: 10px auto;
        }

        #camera, #snapshot {
            width: 100%; /* ã‚³ãƒ³ãƒ†ãƒŠã®å¹…ã«åˆã‚ã›ã¦èª¿æ•´ */
            height: 100%; /* ã‚³ãƒ³ãƒ†ãƒŠã®é«˜ã•ã«åˆã‚ã›ã¦èª¿æ•´ */
            object-fit: cover; /* ã‚¢ã‚¹ãƒšã‚¯ãƒˆæ¯”ã‚’ç¶­æŒã—ã¤ã¤ã€ã‚³ãƒ³ãƒ†ãƒŠã«åˆã‚ã›ã¦ç”»é¢ã‚’åŸ‹ã‚ã‚‹ */
        }

        .button-margin {
            margin: 10px 5px; /* ä¸Šä¸‹ã«10pxã€å·¦å³ã«5pxã®ä½™ç™½ã‚’è¿½åŠ  */
        }

        #prediction-result {
            margin-top: 10px;
        }

        .text-center {
            margin-top: 20px; /* ä¸Šã®ä½™ç™½ã‚’è¨­å®š */
            margin-bottom: 20px; /* ä¸‹ã®ä½™ç™½ã‚’è¨­å®š */
        }
    </style>
    <h5 class="text-center">ãƒœãƒ¯ãƒƒãƒˆãƒ»ã‚¢ãƒ»ãƒ“ã‚¹ã‚­ãƒ¥ã‚¤ã‚’åˆ¤å®šğŸ«ğŸ¥®</h5>
</head>
<body>
    <div class="text-center">
        <div class="camera-container">
            <video id="camera" width="320" height="240" autoplay></video>
            <canvas id="snapshot" width="320" height="240" style="display: none; position: absolute; top: 0; left: 0;"></canvas>
        </div>
        <button id="shoot" type="button" class="btn btn-outline-warning button-margin">æ’®å½±</button>
        <button id="retake" type="button" class="btn btn-outline-warning button-margin" style="display: none;">å–ã‚Šç›´ã—</button>
        <button id="predict" type="button" class="btn btn-outline-warning button-margin" style="display: none;">åˆ¤å®š</button>

        <div id="prediction-result"></div>
    </div>
<script>
        const camera = document.getElementById('camera');
        const canvas = document.getElementById('snapshot');
        const context = canvas.getContext('2d');
        const shootButton = document.getElementById('shoot');
        const predictButton = document.getElementById('predict');
        const resultContainer = document.getElementById('prediction-result');
        const retakeButton = document.getElementById('retake');

        retakeButton.addEventListener('click', () => {
            canvas.style.display = 'none';  // ã‚­ãƒ£ãƒ³ãƒã‚¹ã‚’éè¡¨ç¤ºã«ã™ã‚‹
            camera.style.display = 'block'; // ã‚«ãƒ¡ãƒ©ã‚’è¡¨ç¤ºã™ã‚‹
            context.clearRect(0, 0, canvas.width, canvas.height); // ã‚­ãƒ£ãƒ³ãƒã‚¹ã‚’ã‚¯ãƒªã‚¢ã™ã‚‹
            predictButton.style.display = 'none'; // æ¨è«–ãƒœã‚¿ãƒ³ã‚’éè¡¨ç¤ºã«ã™ã‚‹
            retakeButton.style.display = 'none'; // å–ã‚Šç›´ã—ãƒœã‚¿ãƒ³ã‚’éè¡¨ç¤ºã«ã™ã‚‹
        });

        navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } })
            .then(stream => {
                camera.srcObject = stream;
                camera.onloadedmetadata = () => {
                    // ã‚«ãƒ¡ãƒ©ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã¨ã‚­ãƒ£ãƒ³ãƒã‚¹ã®ã‚µã‚¤ã‚ºã‚’1:1ã«è¨­å®š
                    camera.width = 200;
                    camera.height = 200;
                    canvas.width = 200;
                    canvas.height = 200;
                };
            })
            .catch(err => {
                console.error("ã‚«ãƒ¡ãƒ©ã®èµ·å‹•ã«å¤±æ•—ã—ã¾ã—ãŸ:", err);
            });

        shootButton.addEventListener('click', () => {
            canvas.style.display = 'block';
            camera.style.display = 'none';
            context.drawImage(camera, 0, 0, canvas.width, canvas.height);
            predictButton.style.display = 'inline';
            retakeButton.style.display = 'inline'; // å–ã‚Šç›´ã—ãƒœã‚¿ãƒ³ã‚’è¡¨ç¤º
        });

        predictButton.addEventListener('click', () => {
            const imageData = canvas.toDataURL('image/png').replace(/^data:image\/(png|jpg);base64,/, '');

            const csrftoken = document.querySelector('[name=csrf-token]').content;

            fetch('/biscuit/', {
                method: 'POST',
                body: JSON.stringify({ image: imageData }),
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrftoken
                }
            })
            .then(response => response.json())
            .then(data => {
                resultContainer.textContent = 'åˆ¤å®šçµæœ: ' + data.prediction;
            })
            .catch(error => console.error('ã‚¨ãƒ©ãƒ¼:', error));

        });
    </script>
    </div>
</body>
</html>
{% endblock %}
